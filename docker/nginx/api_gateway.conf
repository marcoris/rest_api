log_format api_main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" "$api_name"';

include api_backends.conf

limit_req_zone $binary_remote_addr zone=client_ip_10rps:1m rate=10r/s;
limit_req_zone $http_apikey zone=apikey_200rps:1m rate=200r/s;

server {
    set $api_name -; # Start with an undefined API name
    access_log log/api_access.log api_main;

    listen 443 ssl;
    server_name api.example.com;

    ssl_certificate         /etc/nginx/ssl/api.example.com.crt;
    ssl_certificate_key     /etc/nginx/ssl/api.example.com.key;

    include api_conf.d/*.conf

    # Error responses
    location / {
        return 404;                 # Catch-all for unrecognized URIs
    }
    error_page 404 = @400;          # Invalid paths are treated as bad requests
    proxy_intercept_errors on;      # Do not send endpoint errors to the client
    include api_json_err.conf;      # API client friendly JSON error responses
    default_type application/json;  # If no content-type then assume JSON
}